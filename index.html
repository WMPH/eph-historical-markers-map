<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Encyclopedia of Philippine Heritage: Historical Markers Map</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600" />
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.css" />
<link rel="stylesheet" href="MarkerCluster.css" />
<link rel="stylesheet" href="MarkerCluster.Default.css" />
<script src="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.js"></script>
<script src="leaflet.markercluster.js"></script>
<style>

html, body {
 margin: 0;
 padding: 0;
 height: 100%;
 font-family: "Open Sans", sans-serif;
}

button {
 padding: 3px 6px;
 font-size: 11px;
 line-height: 11px;
 border: 1px solid #555;
 border-radius: 25px;
 text-decoration: none;
 text-transform: uppercase;
 color: #ccc;
 background: #707070;
 background-image: linear-gradient(to bottom, #808080, #707070);
 cursor: pointer;
}
button::-moz-focus-inner { border: none; }
button:hover {
 color: #fff;
 background: #789;
 background-image: linear-gradient(to bottom, #abc, #789);
}

#branding {
 position: absolute;
 width: 250px;
 background: #555;
 font-weight: 600;
}

#branding p {
 margin: 6px 10px 0;
 padding: 0;
 font-size: 9px;
 line-height: 9px;
 font-weight: 600;
 text-transform: uppercase;
 letter-spacing: 1px;
 color: #889;
}

#branding h1 {
 margin: 4px 10px 2px;
 padding: 0;
 font-size: 18px;
 line-height: 1em;
 color: #ddd;
}

#about-button {
 margin: 0 10px 8px;
 border: 1px solid #444;
 background: #606060;
 background-image: linear-gradient(to bottom, #707070, #606060);
}
#about-button:hover {
 color: #fff;
 background: #789;
 background-image: linear-gradient(to bottom, #abc, #789);
}

nav {
 position: absolute;
 width: 250px;
}

#nav-header {
 padding: 8px 10px;
 color: #aaa;
 background: #666;
}

#nav-header p {
 margin: 0 0 4px 0;
 font-size: 10px;
 line-height: 10px;
}

#nav-header a {
 color: #aab;
}

#sort {
 margin-top: 4px;
}

#nav-list {
 margin: 0;
 padding: 0;
 overflow: auto;
 font-size: 11px;
 line-height: 11px;
 color: #fff;
 background: #888;
}

#left-spinner {
 display: block;
 margin: 8px auto;
}

#nav-list li {
 margin: 0;
 padding: 5px 10px;
 border-bottom: 1px solid #777;
 cursor: pointer;
}
#nav-list li:hover {
 color: #bbf;
 background: #777;
}

#map {
 height: 100%;
 margin-left: 250px;
}

.leaflet-popup-content-wrapper {
 overflow: hidden;
}

.leaflet-popup-close-button {
 display: none;
}

.popup {
 font-family: "Open Sans", sans-serif;
}

.popup h1 {
 margin: -14px -20px 14px;
 padding: 10px 20px 8px;
 width: 401px;
 font-size: 20px;
 line-height: 20px;
 font-weight: 600;
 font-variant: small-caps;
 background: #666;
}

.popup h1 a {
 color: #ddd;
 text-decoration: none;
 border-bottom: 1px dotted #99a;
}
.popup h1 a:hover { color: #bbf; }

.popup h1.untitled {
 font-style: italic;
}

.popup .inscription {
 float: left;
 margin: 0 15px 15px 0;
 width: 235px;
 font-size: 11px;
 line-height: 16px;
 max-height: 400px;
 overflow-y: auto;
}

.popup .inscription p {
 margin: 0;
}

.popup .inscription p+p {
 margin-top: 10px;
}

.popup .details {
 float: right;
 padding: 0 0 15px 0;
 width: 150px;
 font-size: 11px;
 line-height: 16px;
}

.popup .image.sized {
 background: #ccc;
}

.popup .image a {
 display: block;
 text-decoration: none;
}

.popup .image img {
 display: block;
}

.popup .image.nodata {
 height: 100px;
 line-height: 100px;
 text-align: center;
 background: #eee;
}

.popup .extra {
 margin: 0;
 padding: 8px 0 0 0;
}

.popup dt {
 font-size: 9px;
 font-weight: 600;
 text-transform: uppercase;
 color: #aaa;
}

.popup dd {
 margin: 0;
 padding: 0;
 text-indent: 0;
}

.popup dd a {
 text-decoration: none;
 border-bottom: 1px dotted #ccc;
}

.popup dd+dd {
 margin: 5px 0;
}

.popup dd+dt {
 margin-top: 8px;
 padding-top: 8px;
 border-top: 1px solid #ccc;
}

.popup .nodata {
 font-style: italic;
 color: #888;
}

/* Match Leaflet's control style */
.powered {
 line-height: 0.5;
 background: #fff;
 box-shadow: 0 1px 5px rgba(0,0,0,0.65);
 border-radius: 4px;
 overflow: hidden;
}

#about {
 visibility: hidden;
 opacity: 0;
 position: fixed;
 top: 0; left: 0; right: 0; bottom: 0;
 background: rgba(0,0,0,0.7);
 z-index: 1000;
 transition: all 0.2s ease-in-out;
}

#about-modal {
 position: relative;
 width: 600px;
 overflow: auto;
 margin: 20px auto;
 background: #fff;
 border-radius: 12px;
 padding: 20px;
 box-shadow: 0 3px 14px rgba(0,0,0,0.7);
}

#about-modal .close {
 position: absolute;
 top: 10px;
 right: 18px;
 font-size: 20px;
 font-weight: bold;
 color: #888;
 cursor: pointer;
}

#about-modal header {
 position: absolute;
 top: 0; left: 0;
 width: 125px;
 padding: 20px;
 background: #666;
}

#about-modal header h1 {
 margin: 5px 0 0 0;
 font-size: 20px;
 line-height: 25px;
 color: #aaa;
 text-align: right;
 text-shadow: 1px 1px #555;
}

#about-modal section {
 margin: 0 0 0 165px;
}

#about-modal section h2 {
 margin: 0;
 padding: 0;
 font-size: 20px;
 line-height: 20px;
 font-weight: 600;
 font-variant: small-caps;
 color: #666;
}

#about-modal p {
 margin-bottom: 10px;
 font-size: 13px;
 line-height: 20px;
}

#about-modal a {
 text-decoration: none;
 color: #888;
}
#about-modal p a:hover {
 color: #bbf;
 text-decoration: underline;
}

#about-modal footer {
 margin: 0 0 0 165px;
 text-align: right;
}

</style>
</head>
<body>
 <header id="branding" role="banner">
  <p>Encyclopedia of Philippine Heritage</p>
  <h1>Historical Markers Map</h1>
  <button id="about-button">About this app</button>
 </header>
 <nav>
  <header id="nav-header">
   <p id="stats">Loading...</p>
   <button id="sort">Sort list</button>
  </header>
  <ol id="nav-list"><li><img src="spinner1.gif" id="left-spinner"></li></ol>
 </nav>
 <section id="map"></section>
 <aside id="about">
  <div id="about-modal">
   <div class="close">×</div>
   <header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Encyclopedia_of_Philippine_Heritage_logo.svg/125px-Encyclopedia_of_Philippine_Heritage_logo.svg.png" alt="Encyclopedia of Philippine Heritage">
    <h1>Historical Markers Map</h1>
   </header>
   <section>
    <h2>About</h2>
    <p>This <b>Historical Markers Map</b> is a simple web app that shows the
     location of historical markers that have been installed by the
     <a href="https://en.wikipedia.org/wiki/National_Historical_Commission_of_the_Philippines">National
     Historical Commission of the Philippines</a> and its predecessor agencies.
     Each historical marker is represented by a map marker that when clicked
     provides more information about the historical marker, including a photo of
     the marker and its encoded inscription.</p>
    <p>The data on these historical markers comes from <a href="https://www.wikidata.org/">Wikidata</a>,
     a sister project of Wikipedia, and is compiled as part of the <i><b>Encyclopedia
     of Philippine Heritage</b></i>, a program of <a href="http://www.wikimedia.org.ph/">Wikimedia
     Philippines</a>. If you want to help add and improve the data, please refer
     to this <a href="https://www.wikidata.org/wiki/Wikidata:WikiProject_Philippine_historical_markers">WikiProject page</a>.</p>
    <p>If you are familiar with the Wikidata Query Service and want to
     obtain or explore the raw data, please refer to this <a href="#" id="wdqs-link">query</a>.</p>
    <p>To report bugs, suggest improvements, or see the source code of this map
     app, please refer to this app’s <a href="https://github.com/WMPH/eph-historical-markers-map">GitHub
     repository</a>.</p>
   </section>
   <footer>
    <a href="https://www.wikidata.org/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Wikidata-logo-en.svg/85px-Wikidata-logo-en.svg.png" alt="[Wikidata]"></a>
    <a href="http://www.wikimedia.org.ph/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Wikimedia_Philippines.svg/60px-Wikimedia_Philippines.svg.png" alt="[Wikimedia Philippines]"></a>
   </footer>
  </div>
 </aside>
 <script>
"use strict";

var MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

// Wikidata parameters
var NL = "\n";
var SPARQL_QUERY =
'SELECT ?marker ?markerLabel ?coord ?title ?titleNoValue ?image' + NL +
'       ?date ?datePrecision ?inscription ?inscriptionNoValue ?country ?countryLabel' + NL +
'       ?admin0Label ?admin0Type ?admin1Label ?admin1Type' + NL +
'       ?admin2Label ?admin2Type ?admin3Label ?admin3Type' + NL +
'       ?commemorated ?commemoratedLabel ?article WHERE {' + NL +
'  ?marker wdt:P31 wd:Q21562164 ;' + NL +
'          wdt:P625 ?coord .' + NL +
'  OPTIONAL { ?marker wdt:P1476 ?title . }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P1476 ?titleStatement .' + NL +
'    ?titleStatement a ?titleNoValue .' + NL +
'    FILTER (?titleNoValue = wdno:P1476)' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P18 ?image . }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P571 ?dateStatement .' + NL +
'    ?dateStatement psv:P571 ?dateValue .' + NL +
'    ?dateValue wikibase:timeValue ?date .' + NL +
'    ?dateValue wikibase:timePrecision ?datePrecision .' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P1684 ?inscription . }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P1684 ?inscriptionStatement .' + NL +
'    ?inscriptionStatement a ?inscriptionNoValue .' + NL +
'    FILTER (?inscriptionNoValue = wdno:P1684)' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P17 ?country . }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P131 ?admin0 .' + NL +
'    OPTIONAL {' + NL +
'      ?admin0 wdt:P31 ?admin0Type .' + NL +
'      FILTER (' + NL +
'        ?admin0Type = wd:Q6256   ||' + NL +
'        ?admin0Type = wd:Q24698  ||' + NL +
'        ?admin0Type = wd:Q24746  ||' + NL +
'        ?admin0Type = wd:Q104157' + NL +
'      )' + NL +
'    }' + NL +
'    OPTIONAL {' + NL +
'      ?admin0 wdt:P131 ?admin1 .' + NL +
'      OPTIONAL {' + NL +
'        ?admin1 wdt:P31 ?admin1Type .' + NL +
'        FILTER (' + NL +
'          ?admin1Type = wd:Q6256   ||' + NL +
'          ?admin1Type = wd:Q24698  ||' + NL +
'          ?admin1Type = wd:Q24746  ||' + NL +
'          ?admin1Type = wd:Q104157' + NL +
'        )' + NL +
'      }' + NL +
'      OPTIONAL {' + NL +
'        ?admin1 wdt:P131 ?admin2 .' + NL +
'        OPTIONAL {' + NL +
'          ?admin2 wdt:P31 ?admin2Type .' + NL +
'          FILTER (' + NL +
'            ?admin2Type = wd:Q6256   ||' + NL +
'            ?admin2Type = wd:Q24698  ||' + NL +
'            ?admin2Type = wd:Q24746  ||' + NL +
'            ?admin2Type = wd:Q104157' + NL +
'          )' + NL +
'        }' + NL +
'        OPTIONAL {' + NL +
'          ?admin2 wdt:P131 ?admin3 .' + NL +
'          OPTIONAL {' + NL +
'            ?admin3 wdt:P31 ?admin3Type .' + NL +
'            FILTER (' + NL +
'              ?admin3Type = wd:Q6256   ||' + NL +
'              ?admin3Type = wd:Q24698  ||' + NL +
'              ?admin3Type = wd:Q24746  ||' + NL +
'              ?admin3Type = wd:Q104157' + NL +
'            )' + NL +
'          }' + NL +
'        }' + NL +
'      }' + NL +
'    }' + NL +
'  }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P547 ?commemorated .' + NL +
'    OPTIONAL {' + NL +
'      ?article schema:about ?commemorated ;' + NL +
'               schema:isPartOf <https://en.wikipedia.org/> .' + NL +
'    }' + NL +
'  }' + NL +
'  SERVICE wikibase:label { bd:serviceParam wikibase:language "en" . }' + NL +
'}';
var SPARQL_QUERY_ESCAPED = escape(SPARQL_QUERY);
var WDQS_API_URL         = 'https://query.wikidata.org/sparql?format=json&query=' + SPARQL_QUERY_ESCAPED;
var WDQS_GUI_URL         = 'https://query.wikidata.org/#' + SPARQL_QUERY_ESCAPED;
var YEAR_PRECISION       = '9';
var DATE_PRECISION       = '11';
var PH_QID               = 'Q928';
var ADMIN_QIDS           = {};
var COUNTRY_QID          = 'Q6256';    ADMIN_QIDS[COUNTRY_QID     ] = true;
var REGION_QID           = 'Q24698';   ADMIN_QIDS[REGION_QID      ] = true;
var PROVINCE_QID         = 'Q24746';   ADMIN_QIDS[PROVINCE_QID    ] = true;
var CITY_QID             = 'Q104157';  ADMIN_QIDS[CITY_QID        ] = true;
var MUNICIPALITY_QID     = 'Q24764';   ADMIN_QIDS[MUNICIPALITY_QID] = true;
// NOTE: MUNICIPALITY_QID is currently unused and is not included in the SPARQL FILTER

// Other app parameters
var ADMIN_LEVELS           = 4;
var TILE_LAYER_URL         = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var TILE_LAYER_ATTRIBUTION = 'Base map &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>';
var TILE_LAYER_MAX_ZOOM    = 19;
var MIN_PH_LAT             =   4.5;
var MAX_PH_LAT             =  21.0;
var MIN_PH_LON             = 116.5;
var MAX_PH_LON             = 126.5;

var Markers = {}; // Hash to contain data about historical markers
var Map;          // Leaflet map object
var Cluster;      // Leaflet map cluster
var SortModes = [
  { id: 'alpha', label: 'alphabetically' },
  { id: 'qid',   label: 'by Wikidata ID' },
];
var CurrentSortModeIdx;

window.addEventListener('load', init);
window.addEventListener('resize', resizePage);

// Function to initialize the app once the page has been loaded
function init() {

  var anchorElem, powered;
  var xhrObject = new XMLHttpRequest();

  // Initialize the map and add the tile layer
  Map = new L.map('map');
  new L.tileLayer(TILE_LAYER_URL, {
    attribution: TILE_LAYER_ATTRIBUTION,
    maxZoom: TILE_LAYER_MAX_ZOOM,
  }).addTo(Map);

  resizePage();

  // Enable show about button
  document.getElementById('about-button').addEventListener('click', showAbout);

  // Enable hide about button
  document.querySelector('#about .close').addEventListener('click', hideAbout);
  document.getElementById('about').addEventListener('click', hideAbout);
  document.getElementById('about-modal').addEventListener('click', function(ev){
      ev.stopPropagation();
  });

  // Add Wikidata Query Service GUI URL
  anchorElem = document.getElementById('wdqs-link');
  anchorElem.href = WDQS_GUI_URL;

  // Add powered by Wikidata map control
  powered = L.control({position: 'bottomleft'});
  powered.onAdd = function(Map) {
    var divElem = L.DomUtil.create('div', 'powered');
    divElem.innerHTML =
      '<a href="https://www.wikidata.org/"><img src="powered_by_wikidata.png"></a>';
    return divElem;
  };
  powered.addTo(Map);

  // Query Wikidata
  xhrObject.onreadystatechange = processWikidataQuery;
  xhrObject.open('GET', WDQS_API_URL, true);
  xhrObject.overrideMimeType('text/plain');
  xhrObject.send(null);
}

// Function to process the results of the Wikidata query
function processWikidataQuery() {

  if (this.readyState != this.DONE || this.status != 200) return;

  var i, j, numMarkers = 0;
  var wikidataId, record, markerData;
  var labelProp, typeProp, location;
  var mapMarker, listElem, elem;
  var maxLat = -90, maxLon = -180, minLat = 90, minLon = 180;
  var fragmentId;

  var data = JSON.parse(this.responseText);

  // Initialize cluster and list pane
  Cluster = new L.markerClusterGroup({
    maxClusterRadius: function(z) {
      if (z <= 15) return 50;
      if (z <= 16) return 40;
      if (z == 17) return 30;
      if (z == 18) return 20;
      if (z >= 19) return 10;
    },
  });
  listElem = document.getElementById('nav-list');
  listElem.innerHTML = '';

  // Go through each query result
  for (i = 0; i < data.results.bindings.length; i++) {

    // Parse and store basic historical marker data
    record = data.results.bindings[i];
    wikidataId = getWikidataID(record.marker);
    markerData = Markers[wikidataId] || {};
    Markers[wikidataId] = markerData;
    markerData.title = (record.title ? record.title.value : '') || record.markerLabel.value.replace(/ ?historical marker/i, '');
    markerData.titleIsNoValue = Boolean(record.titleNoValue);
    markerData.lat = parseFloat(record.coord.value.split(/\(|\)| /)[2]);
    markerData.lon = parseFloat(record.coord.value.split(/\(|\)| /)[1]);
    markerData.imageUrl = (record.image ? record.image.value.replace('http://commons.wikimedia.org/wiki/Special:FilePath/', 'File:') : '');
    markerData.inscription = (record.inscription ? formatInscription(record.inscription.value) : '');
    markerData.inscriptionIsNoValue = Boolean(record.inscriptionNoValue);
    markerData.commemorated = markerData.commemorated || {};
    if (record.commemorated && !markerData.commemorated[getWikidataID(record.commemorated)]) {
      markerData.hasCommemorated = true;
      markerData.commemorated[getWikidataID(record.commemorated)] = {
        title  : record.commemoratedLabel.value,
        wp_url : (record.article ? record.article.value : ''),
      };
    }

    // Parse and store deduplicated and preferred admin division data
    if (!markerData.adminLabels) markerData.adminLabels = [];
    if (!markerData.adminTypes ) markerData.adminTypes  = [];
    for (j = 0; j < ADMIN_LEVELS; j++) {
      labelProp = 'admin' + j + 'Label';
      if (!markerData.adminLabels[j] && record[labelProp]) {
        markerData.adminLabels[j] = record[labelProp].value;
      }
      typeProp = 'admin' + j + 'Type';
      if ((!markerData.adminTypes[j] || !ADMIN_QIDS[markerData.adminTypes[j]]) && record[typeProp]) {
        markerData.adminTypes[j] = getWikidataID(record[typeProp]);
      }
    }

    // Update location
    location = '';
    for (j = 0; j < ADMIN_LEVELS; j++) {
      if (
        markerData.adminLabels[j] && markerData.adminTypes[j] != COUNTRY_QID && (j == 0 || (
          markerData.adminTypes[j-1] != PROVINCE_QID &&
          markerData.adminTypes[j-1] != REGION_QID && (
            // Don't display the region for HUCs unless it's Metro Manila
            markerData.adminTypes[j-1] != CITY_QID ||
            markerData.adminTypes[j] != REGION_QID ||
            markerData.adminLabels[j] == 'Metro Manila'
          )
        ))
      ) {
        location += (location ? ', ' : '') + markerData.adminLabels[j];
      } else {
        break;
      }
    }
    if (record.country && getWikidataID(record.country) != PH_QID) {
      location += (location ? ', ' : '') + record.countryLabel.value;
    }
    markerData.location = location;

    // Format date or year installed string
    if (record.date) {
      markerData.datePrecision = record.datePrecision.value;
      if (record.datePrecision.value == YEAR_PRECISION) {
        markerData.date = record.date.value.substr(0, 4);
      } else {
        markerData.date =
          MONTH_NAMES[Number(record.date.value.substr(5, 2)) - 1] + ' ' +
          Number(record.date.value.substr(8, 2)) + ', ' +
          record.date.value.substr(0, 4);
      }
    } else {
      markerData.date = '';
    }

    // Update the bounding box containing all markers
    if (
      MIN_PH_LAT <= markerData.lat && markerData.lat <= MAX_PH_LAT &&
      MIN_PH_LON <= markerData.lon && markerData.lon <= MAX_PH_LON
    ) {
      minLat = Math.min(markerData.lat, minLat);
      maxLat = Math.max(markerData.lat, maxLat);
      minLon = Math.min(markerData.lon, minLon);
      maxLon = Math.max(markerData.lon, maxLon);
    }

    if (!markerData.marker) {

      numMarkers++;

      // Create a map marker and add to the cluster
      mapMarker = L.marker([markerData.lat, markerData.lon]);
      mapMarker.bindPopup('', {maxWidth: 400});
      Cluster.addLayer(mapMarker);
      markerData.marker = mapMarker;
      markerData.popup = mapMarker.getPopup();
      markerData.marker._wikidataId = wikidataId;
      markerData.popup._wikidataId = wikidataId;

      // Add the historical marker to the list pane and add click event handling
      elem = document.createElement('li');
      elem.innerHTML = markerData.title;
      elem._wikidataId = wikidataId;
      elem.addEventListener('click', function(ev) {
        zoomToAndOpenMarkerPopup(ev.target._wikidataId);
      });
      markerData.listItemElem = elem;
      listElem.appendChild(elem);
    }
  }

  // Update the map to add the clustered markers and display total number of markers
  Map.addLayer(Cluster);
  document.getElementById('stats').innerHTML = 'Showing a total of ' + numMarkers + ' markers';

  // Update the map to add popup event handlers
  Map.on('popupopen', handlePopup);
  Map.on('popupclose', function() {
    window.location.hash = '';
  });

  // Update the map view to fit the markers or display the selected marker if any
  fragmentId = window.location.hash.replace('#', '');
  if (Markers[fragmentId]) {
    zoomToAndOpenMarkerPopup(fragmentId);
  } else {
    if (fragmentId == 'about') showAbout();
    Map.fitBounds(new L.LatLngBounds([minLat, minLon], [maxLat, maxLon]), {
      padding: new L.Point(0, 0),  // TODO: Leaflet v1.0.0-rc.1 has a bug for padding
    });
  }

  // Enable sort button and add click event handler, and perform initial sort
  elem = document.getElementById('sort');
  elem.disabled = false;
  elem.addEventListener('click', switchSortMode);
  CurrentSortModeIdx = SortModes.length - 1;
  switchSortMode();
}

// Function to zoom to a specified historical marker and open its popup
function zoomToAndOpenMarkerPopup(markerWikidataId) {
  var markerData = Markers[markerWikidataId];
  var mapMarker = markerData.marker;
  Map.setView([markerData.lat, markerData.lon], TILE_LAYER_MAX_ZOOM, {
    animate: false,
  });
  Cluster.zoomToShowLayer(mapMarker, function() {
    mapMarker.openPopup();
  });
}

// Function to handle when a map popup is opened
function handlePopup(e) {

  var i;
  var wikidataId = e.popup._wikidataId;
  var markerData = Markers[e.popup._wikidataId];
  var commemoratedIDs, commemoratedData;
  var popupContent, popupContentHtmlString;
  var titleHtmlString, inscriptionHtmlString, imageHtmlString, commemoratedHtmlString;
  var hasWpArticle, mediawikiApiUrl;

  window.location.hash = '#' + wikidataId;

  if (markerData.isPopupSet) return;
  markerData.isPopupSet = true;

  // Create initial popup content of known marker data

  titleHtmlString =
    '<h1' + (markerData.titleIsNoValue ? ' class="untitled"' : '') + '>' +
    '<a href="https://www.wikidata.org/wiki/' + wikidataId + '">' +
    (markerData.titleIsNoValue ? 'Untitled' : markerData.title) + '</a></h1>';

  inscriptionHtmlString =
    '<div class="inscription' + (markerData.inscriptionIsNoValue ? ' nodata' : '') + '">' +
    (
      markerData.inscriptionIsNoValue
      ? 'This historical marker has no inscription.'
      : (markerData.inscription || '<img src="spinner2.gif">')
    ) + '</div>';

  imageHtmlString =
    '<div class="image' + (markerData.imageUrl ? '' : ' nodata') + '">' +
    (markerData.imageUrl ? '<img src="spinner2.gif">' : 'No photo available' ) + '</div>';

  if (markerData.hasCommemorated) {
    commemoratedIDs = Object.keys(markerData.commemorated);
    commemoratedHtmlString = '';
    hasWpArticle = false;
    for (i = 0; i < commemoratedIDs.length; i++) {
      commemoratedData = markerData.commemorated[commemoratedIDs[i]];
      if (commemoratedData.wp_url) {
        hasWpArticle = true;
        commemoratedHtmlString += '<dd><a href="' + commemoratedData.wp_url + '">' + commemoratedData.title + '</a></dd>';
      } else {
        commemoratedHtmlString += '<dd>' + commemoratedData.title + '</dd>';
      }
    }
    if (!hasWpArticle) {
      commemoratedHtmlString = '<dd class="nodata">No Wikipedia articles yet</dd>';
    }
  } else {
    commemoratedHtmlString = '<dd class="nodata">Unspecified</dd>';
  }

  popupContentHtmlString =
    titleHtmlString +
    inscriptionHtmlString +
    '<div class="details">' +
    imageHtmlString +
    '<dl class="extra">' +
    '<dt>' + (markerData.datePrecision == YEAR_PRECISION ? 'Year' : 'Date') + ' installed</dt>' +
    '<dd' + (markerData.date ? ('>' + markerData.date) : ' class="nodata">Unknown') + '</dd>' +
    '<dt>Location</dt>' +
    '<dd' + (markerData.location ? ('>' + markerData.location) : ' class="nodata">Unspecified') + '</dd>' +
    '<dt>Commemorates</dt>' +
    commemoratedHtmlString +
    '</dl>' +
    '</div>';

  popupContent = document.createElement('div');
  popupContent.className = 'popup';
  popupContent.innerHTML = popupContentHtmlString;
  e.popup._content = popupContent;
  e.popup.setContent(popupContent);
  e.popup.update();

  // If there's an image fetch the thumbnail URL and then update popup content
  if (markerData.imageUrl) {
    mediawikiApiUrl =
      'http://commons.wikimedia.org/w/api.php?action=query' +
      '&prop=imageinfo&iiprop=url&iiurlwidth=150&format=json' +
      '&titles=' + markerData.imageUrl;
    loadJSONP(mediawikiApiUrl, function(data) {
      var pageId = Object.keys(data.query.pages)[0];
      var thumbUrl    = data.query.pages[pageId].imageinfo[0].thumburl;
      var thumbHeight = data.query.pages[pageId].imageinfo[0].thumbheight;
      var descUrl = data.query.pages[pageId].imageinfo[0].descriptionurl;
      var imageCell = markerData.popup._content.querySelector('.image');
      imageCell.innerHTML = '<a href="' + descUrl + '"><img id="img' + wikidataId + '" src="' + thumbUrl + '"></a>';
      imageCell.className = 'image sized';
      imageCell.style.height = thumbHeight + 'px';
      markerData.popup.update();
    });
  }

  // Historical marker has no direct inscription:
  // try looking for the {{LongInscription}} template
  if (!markerData.inscriptionIsNoValue && !markerData.inscription) {
    mediawikiApiUrl =
      'https://www.wikidata.org/w/api.php?action=query' +
      '&prop=revisions&rvprop=content&format=json' +
      '&titles=Talk:' + wikidataId;
    loadJSONP(mediawikiApiUrl, function(data) {
      var pageId, talkContent, matches, inscriptionElem;
      pageId = Object.keys(data.query.pages)[0];
      if (pageId != '-1') {
        talkContent = data.query.pages[pageId].revisions[0]['*'];
        matches = talkContent.match(/{{\s*LongInscription[^]*?\|\s*inscription\s*=\s*([^]*?)(?:\||}})/);
        if (matches && matches[1]) markerData.inscription = formatInscription(matches[1]);
      }
      inscriptionElem = markerData.popup._content.querySelector('.inscription');
      if (!markerData.inscription) inscriptionElem.className = 'inscription nodata';
      inscriptionElem.innerHTML = markerData.inscription || 'No inscription encoded';
      markerData.popup.update();
    });
  }
}

// Function to toggle the sort mode and then sort the markers list on the left pane
function switchSortMode() {

  var i, sorter, sortedItems, listElem;

  CurrentSortModeIdx = (CurrentSortModeIdx + 1) % SortModes.length;
  document.getElementById('sort').innerHTML =
    'Sort list ' + SortModes[(CurrentSortModeIdx + 1) % SortModes.length].label;

  sorter = function(getKey, compareKey) {
    return Object.keys(Markers)
      .map(function(el) {
        return { key: getKey(el), item: Markers[el].listItemElem };
      })
      .sort(compareKey)
      .map(function(el) { return el.item });
  };

  if (SortModes[CurrentSortModeIdx].id == 'alpha') {
    sortedItems = sorter(
      function(el) { return Markers[el].title; },
      function(a, b) { return a.key > b.key ? 1 : -1; }
    );
  }
  else { // 'qid'
    sortedItems = sorter(
      function(el) { return Number(el.substring(1)); },
      function(a, b) { return a.key - b.key; }
    );
  }

  listElem = document.getElementById('nav-list');
  listElem.innerHTML = '';
  for (i = 0; i < sortedItems.length; i++) {
    listElem.appendChild(sortedItems[i]);
  }
}

// Function to resize the page elements
function resizePage() {

  // Resize the left pane
  var navElem = document.getElementsByTagName('nav')[0];
  var navListElem = document.getElementById('nav-list');
  var brandingHeight = document.getElementById('branding').clientHeight;
  var navHeaderHeight = document.getElementById('nav-header').clientHeight;
  var variableHeight = window.innerHeight - brandingHeight;
  navElem.style.top = brandingHeight + 'px';
  navElem.style.height = variableHeight + 'px';
  navListElem.style.height = (variableHeight - navHeaderHeight) + 'px';

  // Resize the about modal
  var aboutModal = document.getElementById('about-modal');
  // Set width first as this affects the content height
  if (window.innerWidth < 680) {  // Default CSS width + padding + margin
    aboutModal.style.width = (window.innerWidth - 80) + 'px';  // Default CSS padding + margin
  } else {
    aboutModal.style.width = '600px';  // Default CSS width
  }
  var contentHeight =
    document.querySelector('#about-modal section').clientHeight +
    document.querySelector('#about-modal footer').clientHeight + 10;  // Default CSS p bottom-margin
  if (window.innerHeight < contentHeight + 80) {  // Default CSS padding + margin
    aboutModal.style.height = (window.innerHeight - 80) + 'px';  // Default CSS padding + margin
    aboutModal.style.marginTop = '20px';  // Default CSS margin
  } else {
    aboutModal.style.height = contentHeight + 'px';
    aboutModal.style.marginTop = ((window.innerHeight - contentHeight - 40)/2) + 'px';  // Default CSS margin
  }
  document.querySelector('#about-modal header').style.height = contentHeight + 'px';
}

function showAbout() {
  var about_pane = document.getElementById('about');
  about_pane.style.visibility = 'visible';
  about_pane.style.opacity = 1;
  window.location.hash = '#about';
}

function hideAbout() {
  var about_pane = document.getElementById('about');
  about_pane.style.visibility = 'hidden';
  about_pane.style.opacity = 0;
  window.location.hash = '';
}

function getWikidataID(queryItem) {
  if (!queryItem) return '';
  return queryItem.value.split('/')[4];
}

function formatInscription(text) {
  return '<p>' + text.replace(/\s*<br\s*\/?>(?:<br\s*\/?>)?\s*/gi, '</p><p>') + '</p>';
}

// Library function to load JSONP data
// Sourced from https://gist.github.com/gf3/132080/110d1b68d7328d7bfe7e36617f7df85679a08968
var loadJSONP = (function(){
  var unique = 0;
  return function(url, callback) {

    // initialize
    var name = "_jsonp_" + unique++;
    url += "&callback="+name;

    // Create script
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = url;

    // Setup handler
    window[name] = function(data){
      callback.call(window, data);
      document.getElementsByTagName('head')[0].removeChild(script);
      script = null;
      delete window[name];
    };

    // Load JSON
    document.getElementsByTagName('head')[0].appendChild(script);
  };
})();

 </script>
</body>
</html>
