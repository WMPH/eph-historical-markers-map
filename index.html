<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Encyclopedia of Philippine Heritage: Historical Markers Map</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,600i,700|Merriweather:300,300i" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
<link rel="stylesheet" href="MarkerCluster.css" />
<link rel="stylesheet" href="MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
<script src="leaflet.markercluster.js"></script>
<style>

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  display: flex;
  align-items: stretch;
}

button {
  padding: 3px 6px;
  font-size: 11px;
  line-height: 11px;
  border: 1px solid #555;
  border-radius: 25px;
  text-decoration: none;
  text-transform: uppercase;
  color: #ccc;
  background: #707070;
  background-image: linear-gradient(to bottom, #808080, #707070);
  cursor: pointer;
}
button::-moz-focus-inner { border: none; }
button:hover {
  color: #fff;
  background: #789;
  background-image: linear-gradient(to bottom, #abc, #789);
}

.loader {
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 10px;
  text-indent: -9999em;
  border-top: 5px solid rgba(34, 102, 136, 0.2);
  border-right: 5px solid rgba(34, 102, 136, 0.2);
  border-bottom: 5px solid rgba(34, 102, 136, 0.2);
  border-left: 5px solid #268;
  transform: translateZ(0);
  animation: load8 1.1s infinite linear;
}

@keyframes load8 {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

#panel {
  display: flex;
  flex-direction: column;
  flex: 0 1 500px;
  height: 100%;
  background: #268;
}

#branding {
  font-family: "Open Sans", sans-serif;
}

#branding p {
  margin: 20px 20px 0;
  padding: 0;
  font-size: 12px;
  line-height: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: #598ca6;
}

#branding h1 {
  margin: 5px 20px 15px;
  padding: 0;
  font-size: 24px;
  font-weight: 600;
  line-height: 24px;
  color: #fff;
}

nav ul {
  list-style: none;
  margin: 0 20px;
  padding: 0;
}

nav li {
  display: inline-block;
  margin: 0;
  padding: 0;
}

nav li a {
  display: block;
  position: relative;
  margin: 0 12px 0 0;
  padding: 6px 12px 6px 16px;
  font-size: 12px;
  line-height: 12px;
  font-family: "Open Sans", sans-serif;
  font-weight: 700;
  border-radius: 6px 6px 0 0;
  background: #598ca6;
  color: #046;
  text-decoration: none;
  text-transform: uppercase;
}

nav li a:hover {
  background: #90b2c4;
}

nav li a::after {
  content: '';
  display: inline-block;
  position: absolute;
  top: 0; right: -8px;
  width: 15px;
  height: 24px;
  border-radius: 0 6px 0 0;
  background: inherit;
  transform: skew(30deg);
}

nav li.selected a {
  background: #fff;
}

.panel-content {
  flex: 1;
  margin: 0 0 20px 0;
  overflow-y: auto;
  background: #fff;
}

#index {
  display: flex;
  flex-direction: column;
}

#index header {
  padding: 20px 20px 10px;
}

#index p {
  margin: 0;
  color: #444;
  font-size: 10px;
  line-height: 10px;
}

#index a {
  color: #aab;
}

#sort {
  margin-top: 10px;
}

#marker-list {
  list-style: none;
  flex: 1;
  overflow-y: auto;
  margin: 0;
  padding: 10px 20px;
  background: #e9f0f3;
}

#left-spinner {
  display: block;
  margin: 8px auto;
}

#marker-list li {
  margin: 0;
  padding: 5px 0;
  font-size: 12.5px;
  line-height: 22px;
  border-bottom: 1px solid #ade;
  font-family: "Open Sans", sans-serif;
  font-weight: 400;
  cursor: pointer;
}

#marker-list li:last-child {
  border-bottom: none;
  margin-bottom: 10px;
}

#details {
  display: none;
  padding: 20px;
}

#details figcaption a, #details p a {
  color: #268;
  text-decoration: none;
  border-bottom: 1px dotted #ccc;
}
#details figcaption a:hover, #details p a:hover {
  background: #eee;
  border-bottom: 1px solid #eee;
}

#details .main-wikidata-link {
  display: block;
  float: right;
  margin: 0 0 0 20px;
}

#details h1 {
  margin: 0 0 20px;
  padding: 0 0 10px;
  font-size: 24px;
  line-height: 24px;
  font-family: "Open Sans", sans-serif;
  font-weight: 600;
  border-bottom: 1px solid #ade;
  color: #134;
}

#details h1 .subtitle {
  font-size: 0.75em;
}
#details h1 .subtitle::before {
  content: '\a';
  white-space: pre;
}

#details h1.untitled {
  font-style: italic;
}

#details p, #details li {
  font-size: 12.5px;
  line-height: 22px;
  font-family: Merriweather, serif;
}

#details p {
  margin: 0 0 10px 0;
  padding: 0;
}

#details ul {
  margin: 0 0 0 24px;
  padding: 0;
}

#details ul li {
  margin: 0 0 5px 0;
  padding: 0;
  list-style: square;
}

#details figure {
  float: right;
  margin: 0 0 20px 0;
  padding: 0;
  width: 156px;
  font-size: 13px;
  line-height: 20px;
  font-family: Merriweather, serif;
  background: #eee;
}

#details figure .loader {
  margin: 20px auto;
}

#details figure > a {
  display: block;
  padding: 2px;
  border: 1px solid #ade;
  text-decoration: none;
}

#details figure img {
  display: block;
}

#details figure figcaption {
  display: block;
  padding: 5px 0 0 0;
  font-size: 10px;
  line-height: 18px;
  color: #888;
  background: #fff;
  font-family: "Open Sans", sans-serif;
  font-weight: 400;
}

#details figure figcaption a {
  color: #888;
  text-decoration: none;
  border-bottom: 1px solid #ccc;
}
#details figure figcaption a:hover {
  background: #eee;
  border-bottom: 1px solid #eee;
}

#details figure.nodata {
  height: 100px;
  line-height: 100px;
  text-align: center;
  font-style: italic;
  color: #888;
}

#details .inscription.loading {
  margin: 40px 0;
}

#details .inscription .loader {
  margin: 0 auto;
}

#details .inscription.nodata {
  font-style: italic;
  color: #888;
}

#details .inscription p {
  padding: 0 170px 0 0;
}

#details h2 {
  margin: 0 0 5px 0;
  font-size: 12px;
  line-height: 12px;
  font-family: "Open Sans", sans-serif;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: #8bd;
}

#details h2 {
  clear: right;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #ade;
}

#details p+h2 {
  margin-top: 15px;
}

#details p.nodata {
  font-style: italic;
  color: #888;
}

#details p a.image, #details li a.image {
  display: inline-block;
  border: none;
  margin-left: 10px;
}
#details p a.image:hover, #details li a.image:hover {
  background: none;
  border-bottom: none;
}

#details p a.image img, #details li a.image img {
  vertical-align: middle;
}

#details p.address {
  padding: 0 170px 0 0;
}

#details .vicinity {
  clear: right;
}

#details .vicinity p {
  padding: 0 170px 0 0;
  font-style: italic;
}

#about {
  display: none;
  padding: 20px;
}

#about #eph {
  float: right;
  margin: 0 0 10px 10px;
}

#about p {
  margin: 0 0 10px 0;
  padding: 0;
  font-size: 12.5px;
  line-height: 22px;
  font-family: Merriweather, serif;
}

#about a {
  text-decoration: none;
  color: #888;
}
#about p a:hover {
  color: #bbf;
  text-decoration: underline;
}

#map {
  flex: 1;
}

.marker-cluster {
  background-clip: padding-box;
  border-radius: 20px;
}

.marker-cluster div {
  margin: 5px 0 0 5px;
  width: 30px;
  height: 30px;
  text-align: center;
  border-radius: 15px;
  font: 12px "Open Sans", sans-serif;
  font-weight: bold;
}

.marker-cluster span {
  line-height: 30px;
}

.marker-cluster-small      { background-color: rgba(144, 178, 196, 0.4); }
.marker-cluster-small  div { background-color: rgba(144, 178, 196, 0.6); }
.marker-cluster-medium     { background-color: rgba( 89, 140, 166, 0.4); }
.marker-cluster-medium div { background-color: rgba( 89, 140, 166, 0.6); }
.marker-cluster-large      { background-color: rgba( 32,  96, 128, 0.4); }
.marker-cluster-large  div { background-color: rgba( 32,  96, 128, 0.6); }

.leaflet-popup-close-button {
  display: none;
}

/* Match Leaflet's control style */
.powered {
 line-height: 0.5;
 background: #fff;
 box-shadow: 0 1px 5px rgba(0,0,0,0.65);
 border-radius: 4px;
 overflow: hidden;
}

</style>
</head>
<body>
  <section id="panel">
    <header id="branding" role="banner">
      <p>Encyclopedia of Philippine Heritage</p>
      <h1>Historical Markers Map</h1>
    </header>
    <nav>
      <ul>
        <li class="selected"><a href="#index">Index</a></li>
        <li><a href="#about">About</a></li>
      </ul>
    </nav>
    <section id="index" class="panel-content" data-display="flex">
      <header>
        <p id="stats">Loading...</p>
        <button id="sort">Sort list</button>
      </header>
      <ol id="marker-list">
        <li><div class="loader"></div></li>
      </ol>
    </section>
    <section id="details" class="panel-content" data-display="block">
    </section>
    <aside id="about" class="panel-content" data-display="block">
      <section>
        <p>This <b>Historical Markers Map</b> shows the location of historical markers that have been installed by the
          <a href="https://en.wikipedia.org/wiki/National_Historical_Commission_of_the_Philippines">National Historical
          Commission of the Philippines</a> and its predecessor agencies. Each historical marker is represented by a map
          marker that when clicked provides more information about the historical marker, including a photo of the marker
          and its encoded inscription.</p>
        <img id="eph" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Encyclopedia_of_Philippine_Heritage_logo.svg/125px-Encyclopedia_of_Philippine_Heritage_logo.svg.png" alt="Encyclopedia of Philippine Heritage">
        <p>The data on these historical markers comes from <a href="https://www.wikidata.org/">Wikidata</a>, a sister
          project of Wikipedia, and is compiled as part of the <i><b>Encyclopedia of Philippine Heritage</b></i>, a
          program of <a href="http://www.wikimedia.org.ph/">Wikimedia Philippines</a>. If you want to help add and
          improve the data, please refer to this <a href="https://www.wikidata.org/wiki/Wikidata:WikiProject_Philippine_historical_markers">WikiProject
          page</a>.</p>
        <p>If you are familiar with the Wikidata Query Service and want to obtain or explore the raw data, please refer
          to this <a href="#" id="wdqs-link">query</a>.</p>
        <p>To report bugs, suggest improvements, or see the source code of this map app, please refer to this app’s
          <a href="https://github.com/WMPH/eph-historical-markers-map">GitHub repository</a>.</p>
      </section>
      <footer>
        <a href="https://www.wikidata.org/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Wikidata-logo-en.svg/85px-Wikidata-logo-en.svg.png" alt="[Wikidata]"></a>
        <a href="http://www.wikimedia.org.ph/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Wikimedia_Philippines.svg/60px-Wikimedia_Philippines.svg.png" alt="[Wikimedia Philippines]"></a>
      </footer>
    </aside>
  </section>
  <section id="map">
  </section>
  <script>
'use strict';

const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
const LANGUAGES = {
  'en': {name: 'English', wikidataId: 'Q1860' },
  'tl': {name: 'Tagalog', wikidataId: 'Q34057'},
  'es': {name: 'Spanish', wikidataId: 'Q1321' },
  'de': {name: 'German' , wikidataId: 'Q188'  },
  'fr': {name: 'French' , wikidataId: 'Q150'  },
};
const ORDERED_LANGUAGES = ['en', 'tl', 'es', 'de', 'fr'];

// Wikidata parameters
const NL = "\n";
const SPARQL_QUERY =
'SELECT ?marker ?markerLabel ?coord ?title ?subtitle ?titleNoValue ?image' + NL +
'       ?date ?datePrecision ?inscription ?inscriptionNoValue' + NL +
'       ?country ?countryLabel ?locationLabel ?locationImage ?streetAddress' + NL +
'       ?admin0Label ?admin0Type ?admin1Label ?admin1Type' + NL +
'       ?admin2Label ?admin2Type ?admin3Label ?admin3Type' + NL +
'       ?vicinityImage ?vicinityDescription' + NL +
'       ?commemorates ?commemoratesLabel ?article WHERE {' + NL +
'  ?marker wdt:P31 wd:Q21562164 ;' + NL +
'          wdt:P625 ?coord .' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P1476 ?titleStatement .' + NL +
'    OPTIONAL {' + NL +
'      ?titleStatement ps:P1476 ?title .' + NL +
'      OPTIONAL { ?titleStatement pq:P1680 ?subtitle }' + NL +
'    }' + NL +
'    OPTIONAL {' + NL +
'      ?titleStatement a ?titleNoValue .' + NL +
'      FILTER (?titleNoValue = wdno:P1476)' + NL +
'    }' + NL +
'  }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P18 ?imageStatement .' + NL +
'    OPTIONAL {' + NL +
'      ?imageStatement ps:P18 ?image .' + NL +
'      FILTER NOT EXISTS { ?imageStatement pq:P3831 wd:Q16968816 }' + NL +
'    }' + NL +
'    OPTIONAL {' + NL +
'      ?imageStatement ps:P18 ?vicinityImage .' + NL +
'      OPTIONAL { ?imageStatement pq:P2096 ?vicinityDescription }' + NL +
'      FILTER EXISTS { ?imageStatement pq:P3831 wd:Q16968816 }' + NL +
'    }' + NL +
'  }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P571 ?dateStatement .' + NL +
'    ?dateStatement psv:P571 ?dateValue .' + NL +
'    ?dateValue wikibase:timeValue ?date .' + NL +
'    ?dateValue wikibase:timePrecision ?datePrecision .' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P1684 ?inscription }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P1684 ?inscriptionStatement .' + NL +
'    ?inscriptionStatement a ?inscriptionNoValue .' + NL +
'    FILTER (?inscriptionNoValue = wdno:P1684)' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P17 ?country }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P276 ?location .' + NL +
'    OPTIONAL { ?location wdt:P18 ?locationImage }' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P969 ?streetAddress }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P131 ?admin0 .' + NL +
'    OPTIONAL {' + NL +
'      ?admin0 wdt:P31 ?admin0Type .' + NL +
'      FILTER (' + NL +
'        ?admin0Type = wd:Q6256   ||' + NL +
'        ?admin0Type = wd:Q24698  ||' + NL +
'        ?admin0Type = wd:Q24746  ||' + NL +
'        ?admin0Type = wd:Q104157' + NL +
'      )' + NL +
'    }' + NL +
'    OPTIONAL {' + NL +
'      ?admin0 wdt:P131 ?admin1 .' + NL +
'      OPTIONAL {' + NL +
'        ?admin1 wdt:P31 ?admin1Type .' + NL +
'        FILTER (' + NL +
'          ?admin1Type = wd:Q6256   ||' + NL +
'          ?admin1Type = wd:Q24698  ||' + NL +
'          ?admin1Type = wd:Q24746  ||' + NL +
'          ?admin1Type = wd:Q104157' + NL +
'        )' + NL +
'      }' + NL +
'      OPTIONAL {' + NL +
'        ?admin1 wdt:P131 ?admin2 .' + NL +
'        OPTIONAL {' + NL +
'          ?admin2 wdt:P31 ?admin2Type .' + NL +
'          FILTER (' + NL +
'            ?admin2Type = wd:Q6256   ||' + NL +
'            ?admin2Type = wd:Q24698  ||' + NL +
'            ?admin2Type = wd:Q24746  ||' + NL +
'            ?admin2Type = wd:Q104157' + NL +
'          )' + NL +
'        }' + NL +
'        OPTIONAL {' + NL +
'          ?admin2 wdt:P131 ?admin3 .' + NL +
'          OPTIONAL {' + NL +
'            ?admin3 wdt:P31 ?admin3Type .' + NL +
'            FILTER (' + NL +
'              ?admin3Type = wd:Q6256   ||' + NL +
'              ?admin3Type = wd:Q24698  ||' + NL +
'              ?admin3Type = wd:Q24746  ||' + NL +
'              ?admin3Type = wd:Q104157' + NL +
'            )' + NL +
'          }' + NL +
'        }' + NL +
'      }' + NL +
'    }' + NL +
'  }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P547 ?commemorates .' + NL +
'    OPTIONAL {' + NL +
'      ?article schema:about ?commemorates ;' + NL +
'               schema:isPartOf <https://en.wikipedia.org/> .' + NL +
'    }' + NL +
'  }' + NL +
'  SERVICE wikibase:label { bd:serviceParam wikibase:language "en" }' + NL +
'}';

const SPARQL_QUERY_ESCAPED = escape(SPARQL_QUERY);
const WDQS_API_URL         = 'https://query.wikidata.org/sparql';
const WDQS_GUI_URL         = 'https://query.wikidata.org/#' + SPARQL_QUERY_ESCAPED;
const YEAR_PRECISION       = '9';
const DATE_PRECISION       = '11';
const PH_QID               = 'Q928';
var   ADMIN_QIDS           = {};
const COUNTRY_QID          = 'Q6256';    ADMIN_QIDS[COUNTRY_QID     ] = true;
const REGION_QID           = 'Q24698';   ADMIN_QIDS[REGION_QID      ] = true;
const PROVINCE_QID         = 'Q24746';   ADMIN_QIDS[PROVINCE_QID    ] = true;
const CITY_QID             = 'Q104157';  ADMIN_QIDS[CITY_QID        ] = true;
const MUNICIPALITY_QID     = 'Q24764';   ADMIN_QIDS[MUNICIPALITY_QID] = true;
// NOTE: MUNICIPALITY_QID is currently unused and is not included in the SPARQL FILTER

// Other app parameters
const ADMIN_LEVELS           = 4;
const TILE_LAYER_URL         = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const TILE_LAYER_ATTRIBUTION = 'Base map &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>';
const TILE_LAYER_MAX_ZOOM    = 19;
const MIN_PH_LAT             =   4.5;
const MAX_PH_LAT             =  21.0;
const MIN_PH_LON             = 116.5;
const MAX_PH_LON             = 126.5;

var Markers = {}; // Hash to contain data about historical markers
var Map;          // Leaflet map object
var Cluster;      // Leaflet map cluster
var SortModes = [
  { id: 'alpha', label: 'alphabetically' },
  { id: 'qid',   label: 'by Wikidata ID' },
];
var CurrentSortModeIdx;

window.addEventListener('load', init);

// Function to initialize the app once the page has been loaded
function init() {

  var anchorElem, powered;
  var xhrObject = new XMLHttpRequest();

  // Initialize the map and add the tile layer
  Map = new L.map('map');
  new L.tileLayer(TILE_LAYER_URL, {
    attribution: TILE_LAYER_ATTRIBUTION,
    maxZoom: TILE_LAYER_MAX_ZOOM,
  }).addTo(Map);

  // Enable tab menu
  document.querySelector('nav a[href="#index"]').addEventListener('click', showIndex);
  document.querySelector('nav a[href="#about"]').addEventListener('click', showAbout);

  // Add Wikidata Query Service GUI URL
  anchorElem = document.getElementById('wdqs-link');
  anchorElem.href = WDQS_GUI_URL;

  // Add powered by Wikidata map control
  powered = L.control({position: 'bottomleft'});
  powered.onAdd = function(Map) {
    var divElem = L.DomUtil.create('div', 'powered');
    divElem.innerHTML =
      '<a href="https://www.wikidata.org/"><img src="powered_by_wikidata.png"></a>';
    return divElem;
  };
  powered.addTo(Map);

  // Query Wikidata
  xhrObject.onreadystatechange = processWikidataQuery;
  xhrObject.open('POST', WDQS_API_URL, true);
  xhrObject.overrideMimeType('text/plain');
  xhrObject.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhrObject.send('format=json&query=' + SPARQL_QUERY_ESCAPED);
}

// Function to process the results of the Wikidata query
function processWikidataQuery() {

  if (this.readyState != this.DONE || this.status != 200) return;

  var numMarkers = 0;
  var listElem;
  var maxLat = -90, maxLon = -180, minLat = 90, minLon = 180;
  var fragmentId;

  var data = JSON.parse(this.responseText);

  // Initialize cluster and list pane
  Cluster = new L.markerClusterGroup({
    maxClusterRadius: function(z) {
      if (z <= 15) return 50;
      if (z <= 16) return 40;
      if (z == 17) return 30;
      if (z == 18) return 20;
      if (z >= 19) return 10;
    },
  });
  listElem = document.getElementById('marker-list');
  listElem.innerHTML = '';

  // Go through each query result
  for (let i = 0; i < data.results.bindings.length; i++) {

    let queryResult = data.results.bindings[i];
    let wikidataId  = getWikidataID(queryResult.marker);

    if (!(wikidataId in Markers)) Markers[wikidataId] = new MarkerRecord;
    let record = Markers[wikidataId];

    // Parse and store basic historical marker data
    
    if ('title' in queryResult) {
      let langCode = queryResult.title['xml:lang'];
      let main     = queryResult.title.value;
      let sub      = queryResult.subtitle ? queryResult.subtitle.value : null;
      record.title[langCode] = {
        main : main,
        sub  : sub,
      };
      record.indexTitle = main + (sub ? ((sub.substr(0, 1) === '(' ? '' : ':') + ' ' + sub) : '');
    }
    else {
      if ('titleNoValue' in queryResult) {
        record.title = null;
      }
      record.indexTitle = queryResult.markerLabel.value.replace(/ ?historical marker/i, '');
    }
    
    if ('inscription' in queryResult) {
      record.inscription[queryResult.inscription['xml:lang']] = formatInscription(queryResult.inscription.value);
    }
    else if ('inscriptionNoValue' in queryResult) {
      record.inscription = null;
    }

    let coords = queryResult.coord.value.split(/\(|\)| /);
    record.lat = parseFloat(coords[2]);
    record.lon = parseFloat(coords[1]);

    if ('image' in queryResult) {
      record.imageFilename = extractImageFilename(queryResult.image);
    }

    // Format date or year installed string
    if ('date' in queryResult) {
      let dateVal = queryResult.date.value;
      record.datePrecision = queryResult.datePrecision.value;
      if (queryResult.datePrecision.value === YEAR_PRECISION) {
        record.date = dateVal.substr(0, 4);
      }
      else {
        record.date =
          MONTH_NAMES[Number(dateVal.substr(5, 2)) - 1] + ' ' +
          Number(dateVal.substr(8, 2)) + ', ' +
          dateVal.substr(0, 4);
      }
    }

    if ('commemorates' in queryResult) {
      record.commemorates[getWikidataID(queryResult.commemorates)] = {
        title  : queryResult.commemoratesLabel.value,
        wp_url : ('article' in queryResult ? queryResult.article.value : null),
      };
    }

    // Parse and store deduplicated and preferred admin division data
    for (let j = 0; j < ADMIN_LEVELS; j++) {
      let labelProp = 'admin' + j + 'Label';
      if (!record.adminLabels[j] && queryResult[labelProp]) {
        record.adminLabels[j] = queryResult[labelProp].value;
      }
      let typeProp = 'admin' + j + 'Type';
      if ((!record.adminTypes[j] || !ADMIN_QIDS[record.adminTypes[j]]) && queryResult[typeProp]) {
        record.adminTypes[j] = getWikidataID(queryResult[typeProp]);
      }
    }

    // Update location
    let location = '';
    if ('locationLabel' in queryResult) {
      location = queryResult.locationLabel.value;
    }
    if ('streetAddress' in queryResult) {
      location += (location ? ', ' : '') + queryResult.streetAddress.value;
    }
    for (let j = 0; j < ADMIN_LEVELS; j++) {
      if (
        record.adminLabels[j] && record.adminTypes[j] !== COUNTRY_QID && (j === 0 || (
          record.adminTypes[j-1] !== PROVINCE_QID &&
          record.adminTypes[j-1] !== REGION_QID && (
            // Don't display the region for HUCs unless it's Metro Manila
            record.adminTypes[j-1] !== CITY_QID ||
            record.adminTypes[j] !== REGION_QID ||
            record.adminLabels[j] === 'Metro Manila'
          )
        ))
      ) {
        location += (location ? ', ' : '') + record.adminLabels[j];
      }
      else {
        break;
      }
    }
    if ('country' in queryResult && getWikidataID(queryResult.country) != PH_QID) {
      location += (location ? ', ' : '') + queryResult.countryLabel.value;
    }
    record.location.address = location;

    if ('locationImage' in queryResult) {
      record.location.imageFilename = extractImageFilename(queryResult.locationImage);
    }

    if ('vicinityImage' in queryResult) {
      record.vicinity.imageFilename = extractImageFilename(queryResult.vicinityImage);
      if ('vicinityDescription' in queryResult) {
        record.vicinity.description = queryResult.vicinityDescription.value;
      }
    }
    
    // Update the bounding box containing all markers
    if (
      MIN_PH_LAT <= record.lat && record.lat <= MAX_PH_LAT &&
      MIN_PH_LON <= record.lon && record.lon <= MAX_PH_LON
    ) {
      minLat = Math.min(record.lat, minLat);
      maxLat = Math.max(record.lat, maxLat);
      minLon = Math.min(record.lon, minLon);
      maxLon = Math.max(record.lon, maxLon);
    }

    if (!record.mapMarker) {

      numMarkers++;

      // Create a map marker and add to the cluster
      let mapMarker = L.marker([record.lat, record.lon]);
      mapMarker.bindPopup(record.indexTitle);
      mapMarker._wikidataId = wikidataId;
      let popup = mapMarker.getPopup();
      popup._wikidataId = wikidataId;
      
      Cluster.addLayer(mapMarker);
      record.mapMarker = mapMarker;

      // Add the historical marker to the list pane and add click event handling
      let liNode = document.createElement('li');
      liNode.innerHTML = record.indexTitle;
      liNode._wikidataId = wikidataId;
      liNode.addEventListener('click', function(ev) {
        activateMarker(ev.currentTarget._wikidataId);
      });
      record.indexListNode = liNode;
      listElem.appendChild(liNode);
    }
  }
  
  // Clean up
  let markerIds = Object.keys(Markers);
  for (let i = 0; i < markerIds.length; i++) {
    let record = Markers[markerIds[i]];
    if (Object.keys(record.commemorates).length === 0) record.commemorates = null;
    if (!record.vicinity.imageFilename) record.vicinity = null;
  }

  // Update the map to add the clustered markers and display total number of markers
  Map.addLayer(Cluster);
  document.getElementById('stats').innerHTML = 'Showing a total of ' + numMarkers + ' markers';

  // TODO: Update the map to add popup event handlers
  Map.on('popupopen', handlePopup);
  //Map.on('popupclose', function() {
  //  window.location.hash = '';
  //});

  // Update the map view to fit the markers or display the selected marker if any
  fragmentId = window.location.hash.replace('#', '');
  if (Markers[fragmentId]) {
    activateMarker(fragmentId);
  }
  else {
    if (fragmentId == 'about') showAbout();
    Map.fitBounds(new L.LatLngBounds([minLat, minLon], [maxLat, maxLon]), {
      padding: new L.Point(0, 0),  // TODO: Leaflet v1.0.0-rc.1 has a bug for padding
    });
  }

  // Enable sort button and add click event handler, and perform initial sort
  let elem = document.getElementById('sort');
  elem.disabled = false;
  elem.addEventListener('click', switchSortMode);
  CurrentSortModeIdx = SortModes.length - 1;
  switchSortMode();
}

function showPanelContent(contentId) {
  var contents = document.querySelectorAll('.panel-content');
  for (var i = 0; i < contents.length; i++) {
    if (contents[i].id === contentId) {
      contents[i].style.display = contents[i].dataset.display;
    }
    else {
      contents[i].style.display = 'none';
    }
  }
  var menuItems = document.querySelectorAll('nav li');
  for (var i = 0; i < menuItems.length; i++) {
    var link = menuItems[i].querySelector('a');
    if (link.getAttribute('href') === '#' + contentId) {
      menuItems[i].classList.add('selected');
    }
    else {
      menuItems[i].classList.remove('selected');
    }
  }
  window.location.hash = '#' + contentId;
}

function showIndex() {
  showPanelContent('index');
}

function showAbout() {
  showPanelContent('about');
}

function handlePopup(e) {
  activateMarker(e.popup._wikidataId);
}

// Function to zoom to a specified historical marker and open its popup
function activateMarker(wikidataId) {

  var record = Markers[wikidataId];

  // Update the map state to show the historical marker
  var mapMarker = record.mapMarker;
  Map.setView([record.lat, record.lon], TILE_LAYER_MAX_ZOOM, {
    animate: false,  // TODO: Try to enable animation
  });
  Cluster.zoomToShowLayer(mapMarker, function() {
    mapMarker.openPopup();
  });

  var panelNode;
  var mediawikiApiUrl;

  if (record.panelNode) {
    let detailsNode = document.querySelector('#details');
    detailsNode.replaceChild(record.panelNode, detailsNode.childNodes[0]);
    showPanelContent('details');
    window.location.hash = '#' + wikidataId;
    return;
  }

  // Create initial panel content of known marker data

  let titleHtml;
  if (record.title) {
    titleHtml = '<h1>';
    for (let i = 0; i < ORDERED_LANGUAGES.length; i++) {
      let langCode = ORDERED_LANGUAGES[i];
      if (langCode in record.title) {
        let title = record.title[langCode];
        titleHtml += title.main;
        if (title.sub) titleHtml += ' <span class="subtitle">' + title.sub + '</span>';
        break;
      }
    }
    titleHtml += '</h1>';
  }
  else {
    titleHtml = '<h1 class="untitled">Untitled</h1>';
  }

  let markerFigureHtml;
  if (record.imageFilename) {
    markerFigureHtml = '<figure><div class="loader"></div></figure>';
  }
  else {
    markerFigureHtml = '<figure class="nodata">No photo available</figure>';
  }

  let inscriptionHtml;
  if (record.inscription) {
    let inscription;
    for (let i = 0; i < ORDERED_LANGUAGES.length; i++) {
      let langCode = ORDERED_LANGUAGES[i];
      if (langCode in record.inscription) {
        inscription = record.inscription[langCode];
        break;
      }
    }
    if (inscription) {
      inscriptionHtml = '<div class="inscription">' + inscription + '</div>';
    }
    else {
      inscriptionHtml = '<div class="inscription loading"><div class="loader"></div></div>';
    }
  }
  else {
    inscriptionHtml = '<div class="inscription nodata"><p>This historical marker has no inscription.</p></div>';
  }

  let commemoratesHtml = '';
  if (record.commemorates) {
    let commemoratesIds = Object.keys(record.commemorates);
    let tagName = commemoratesIds.length > 1 ? 'li' : 'p';
    commemoratesHtml = commemoratesIds.length > 1 ? '<ul>' : '';
    for (let i = 0; i < commemoratesIds.length; i++) {
      let commemoratesData = record.commemorates[commemoratesIds[i]];
      commemoratesHtml +=
        '<' + tagName + '>' + commemoratesData.title +
        '<a class="image" href="https://www.wikidata.org/wiki/' + commemoratesIds[i] + '" title="View in Wikidata">' +
        '<img src="wikidata_tiny_logo.png" alt="[view Wikidata item]" /></a>' +
        (
          commemoratesData.wp_url
          ? (
            '<a class="image" href="' + commemoratesData.wp_url + '" title="View in Wikipedia">' +
            '<img src="wikipedia_tiny_logo.png" alt="[view Wikipedia article]" /></a>'
          )
          : ''
        ) +
        '</' + tagName + '>';
    }
    commemoratesHtml += commemoratesIds.length > 1 ? '</ul>' : '';
  }
  else {
    commemoratesHtml = '<p class="nodata">Unspecified</p>';
  }

  let locationFigureHtml = '';
  if (record.location.imageFilename) {
    locationFigureHtml = '<figure class="location"><div class="loader"></div></figure>';
  }

  let addressHtml;
  if (record.location.address) {
    addressHtml = '<p class="address">' + record.location.address + '</p>';
  }
  else {
    addressHtml = '<p class="nodata">Unspecified</p>';
  }

  let vicinityHtml = '';
  if (record.vicinity) {
    vicinityHtml = '<div class="vicinity">';
    vicinityHtml += '<figure class="vicinity"><div class="loader"></div></figure>';
    if (record.vicinity.description) {
      vicinityHtml += '<p>' + record.vicinity.description + '</p>';
    }
    vicinityHtml += '</div>'
  }

  let panelHtml =
    '<a class="main-wikidata-link" href="https://www.wikidata.org/wiki/' + wikidataId + '" title="View in Wikidata">' +
    '<img src="wikidata_tiny_logo.png" alt="[view Wikidata item]" /></a>' +
    titleHtml +
    markerFigureHtml +
    inscriptionHtml +
    '<h2>' + (record.datePrecision === YEAR_PRECISION ? 'Year' : 'Date') + ' installed</h2>' +
    '<p' + (record.date ? ('>' + record.date) : ' class="nodata">Unknown') + '</p>' +
    '<h2>Commemorates</h2>' +
    commemoratesHtml +
    '<h2>Location</h2>' +
    locationFigureHtml +
    addressHtml +
    vicinityHtml;

  panelNode = document.createElement('div');
  panelNode.innerHTML = panelHtml;
  let markerFigure = panelNode.childNodes[2];
  let inscriptionNode = panelNode.childNodes[3];
  let locationFigure = panelNode.querySelector('figure.location');
  let vicinityFigure = panelNode.querySelector('figure.vicinity');
  record.panelNode = panelNode;

  showPanelContent('details');
  var details = document.querySelector('#details');
  details.replaceChild(panelNode, details.childNodes[0]);
  window.location.hash = '#' + wikidataId;

  // Load images
  if (record         .imageFilename) displayFigure(record         .imageFilename, markerFigure  );
  if (record.location.imageFilename) displayFigure(record.location.imageFilename, locationFigure);
  if (record.vicinity              ) displayFigure(record.vicinity.imageFilename, vicinityFigure);

  // Historical marker has no direct inscription:
  // try looking for the {{LongInscription}} template
  if (record.inscription && Object.keys(record.inscription).length === 0) {
    mediawikiApiUrl =
      'https://www.wikidata.org/w/api.php?action=query' +
      '&prop=revisions&rvprop=content&format=json' +
      '&titles=Talk:' + wikidataId;
    loadJSONP(mediawikiApiUrl, function(data) {
      let pageId = Object.keys(data.query.pages)[0];
      if (pageId !== '-1') {
        let talkContent = data.query.pages[pageId].revisions[0]['*'];
        let templateStrings = talkContent.match(/{{\s*LongInscription[^]+?}}/g);
        if (templateStrings) {
          for (let i = 0; i < templateStrings.length; i++) {
            let langWikidataId = templateStrings[i].match(/\|\s*langqid\s*=\s*(Q[0-9]+)/)[1];
            let inscription = templateStrings[i].match(/\|\s*inscription\s*=\s*([^]*?)(?:\||}})/)[1];
            for (let j = 0; j < ORDERED_LANGUAGES.length; j++) {
              if (langWikidataId === LANGUAGES[ORDERED_LANGUAGES[j]].wikidataId) {
                record.inscription[ORDERED_LANGUAGES[j]] = formatInscription(inscription);
                break;
              }
            }
          }
        }
      }
      if (Object.keys(record.inscription).length === 0) {
        inscriptionNode.classList.add('nodata');
        inscriptionNode.innerHTML = '<p>No inscription encoded</p>';
      }
      else {
        for (let i = 0; i < ORDERED_LANGUAGES.length; i++) {
          let langCode = ORDERED_LANGUAGES[i];
          if (langCode in record.inscription) {
            inscriptionNode.innerHTML = record.inscription[langCode];
            break;
          }
        }
      }
      inscriptionNode.classList.remove('loading');
    });
  }
}

// Function to toggle the sort mode and then sort the markers list on the left pane
function switchSortMode() {

  var sorter, sortedItems, listNode;

  CurrentSortModeIdx = (CurrentSortModeIdx + 1) % SortModes.length;
  document.getElementById('sort').innerHTML =
    'Sort list ' + SortModes[(CurrentSortModeIdx + 1) % SortModes.length].label;

  sorter = function(getKey, compareKey) {
    return Object.keys(Markers)
      .map(function(el) {
        return { key: getKey(el), item: Markers[el].indexListNode };
      })
      .sort(compareKey)
      .map(function(el) { return el.item });
  };

  if (SortModes[CurrentSortModeIdx].id == 'alpha') {
    sortedItems = sorter(
      function(el) { return Markers[el].indexTitle; },
      function(a, b) { return a.key > b.key ? 1 : -1; }
    );
  }
  else { // 'qid'
    sortedItems = sorter(
      function(el) { return Number(el.substring(1)); },
      function(a, b) { return a.key - b.key; }
    );
  }

  listNode = document.getElementById('marker-list');
  listNode.innerHTML = '';
  for (let i = 0; i < sortedItems.length; i++) {
    listNode.appendChild(sortedItems[i]);
  }
}

function getWikidataID(queryItem) {
  if (!queryItem) return '';
  return queryItem.value.split('/')[4];
}

function formatInscription(text) {
  return '<p>' + text.replace(/\s*<br\s*\/?>(?:<br\s*\/?>)?\s*/gi, '</p><p>') + '</p>';
}

function extractImageFilename(image) {
  return image.value.replace('http://commons.wikimedia.org/wiki/Special:FilePath/', '')
}

function displayFigure(filename, figureNode) {

  var mediawikiApiUrl;

  // Fetch the image thumbnail
  mediawikiApiUrl =
    'http://commons.wikimedia.org/w/api.php?action=query' +
    '&prop=imageinfo&iiprop=url&iiurlwidth=150&format=json' +
    '&titles=File:' + filename;
  loadJSONP(mediawikiApiUrl, function(data) {
    let pageId = Object.keys(data.query.pages)[0];
    let imageInfo = data.query.pages[pageId].imageinfo[0];
    let imageNode = document.createElement('img');
    imageNode.src = imageInfo.thumburl;
    let anchor = document.createElement('a');
    anchor.href = imageInfo.descriptionurl;
    anchor.style.height = imageInfo.thumbheight + 'px';
    anchor.appendChild(imageNode);
    figureNode.replaceChild(anchor, figureNode.childNodes[0]);  // replace spinner
  });

  // Fetch the image attribution if needed
  mediawikiApiUrl =
    'http://commons.wikimedia.org/w/api.php?action=query' +
    '&prop=imageinfo&iiprop=extmetadata&format=json' +
    '&titles=File:' + filename;
  loadJSONP(mediawikiApiUrl, function(data) {
    let pageId = Object.keys(data.query.pages)[0];
    let metadata = data.query.pages[pageId].imageinfo[0].extmetadata;
    if (metadata.AttributionRequired.value === 'true') {
      let artistHtml = metadata.Artist.value;
      if (artistHtml.search('href="//') >= 0) {
        artistHtml = artistHtml.replace(/href="\/\//, window.location.protocol == 'https' ? 'href="https://' : 'href="http://');
      }
      let licenseShortName = metadata.LicenseShortName.value.replace(/ /g, '&nbsp;');
      figureNode.insertAdjacentHTML('beforeend', '<figcaption>' + artistHtml + '<br><a href="' + metadata.LicenseUrl.value + '">' + licenseShortName + '</a></figcaption>');
    }
  });
}

// Library function to load JSONP data
// Sourced from https://gist.github.com/gf3/132080/110d1b68d7328d7bfe7e36617f7df85679a08968
var loadJSONP = (function(){
  var unique = 0;
  return function(url, callback) {

    // initialize
    var name = "_jsonp_" + unique++;
    url += "&callback="+name;

    // Create script
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = url;

    // Setup handler
    window[name] = function(data){
      callback.call(window, data);
      document.getElementsByTagName('head')[0].removeChild(script);
      script = null;
      delete window[name];
    };

    // Load JSON
    document.getElementsByTagName('head')[0].appendChild(script);
  };
})();

function MarkerRecord() {
  this.indexTitle    = '';
  this.title         = {};
  this.inscription   = {};
  this.lat           = 0;
  this.lon           = 0;
  this.imageFilename = '';
  this.date          = '';
  this.datePrecision = YEAR_PRECISION;
  this.commemorates  = {};
  this.location      = { address: '', imageFilename: '' };
  this.vicinity      = { description: '', imageFilename: '' };
  this.adminLabels   = [];
  this.adminTypes    = [];
  this.mapMarker     = undefined;
  this.panelNode     = undefined;
  this.indexListNode = undefined;
}

  </script>
</body>
</html>
